name: 锔 Crear y Mergear PR de Listas IPTV

on:
  # 1. Ejecuci贸n programada: cada 2 horas
  schedule:
    - cron: '0 */2 * * *'
  
  # 2. Ejecuci贸n manual
  workflow_dispatch:

# Permisos necesarios para crear PRs y commitear
permissions:
  contents: write      # Para hacer commit y crear/borrar ramas
  pull-requests: write # Para crear y mergear PRs

jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    
    steps:
      # --- 1. Configuraci贸n Inicial ---
      
      - name: 猬锔 Descargar el c贸digo del repositorio
        uses: actions/checkout@v4

      - name:  Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name:  Instalar dependencias de Python
        run: |
          pip install -r requirements.txt
          
      # --- 2. Ejecuci贸n del Script ---
      
      - name:  Ejecutar el script de Python
        run: |
          python process_streams.py
          
      # --- 3. Generar info.json (usando URLs de raw.github) ---
      
      - name:  Generar info.json
        run: |
          echo '{' > info.json
          echo '  "m3u_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/filtered.m3u",' >> info.json
          echo '  "json_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.json",' >> info.json
          echo '  "xmltv_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.xml"' >> info.json
          echo '}' >> info.json
          
      - name:  Obtener fecha actual (para el t铆tulo del PR)
        run: echo "CURRENT_TIME=$(date -u --iso-8601=seconds)" >> $GITHUB_ENV

      # --- 4. Crear el Pull Request y Hacer Auto-Merge ---
      
      - name:  Crear Pull Request y hacer Auto-Merge
        uses: peter-evans/create-pull-request@v6
        with:
          # Token para autenticaci贸n
          token: ${{ secrets.GITHUB_TOKEN }}
          
          # Configuraci贸n del Commit
          commit-message: "Feat: Actualizar listas IPTV y EPG (${{ env.CURRENT_TIME }})"
          
          # Configuraci贸n de la Rama
          # Usamos el ID de la ejecuci贸n para un nombre de rama 煤nico
          branch: "auto-update/iptv-${{ github.run_id }}"
          delete-branch: true # Borrar la rama despu茅s del merge
          
          # Archivos para incluir en el PR
          add-paths: |
            filtered.m3u
            epg.json
            epg.xml
            info.json
            
          # Configuraci贸n del PR
          title: "Actualizaci贸n autom谩tica de IPTV/EPG | ${{ env.CURRENT_TIME }}"
          body: |
            Este es un PR autom谩tico generado por GitHub Actions.
            - Actualiza el M3U filtrado
            - Actualiza el EPG en XMLTV y JSON
            
          # Configuraci贸n del Auto-Merge
          auto-merge: true
          merge-method: squash # 'squash' junta todos los commits en uno solo
