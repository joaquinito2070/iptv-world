# .github/workflows/update.yml

name: Actualizar Playlist IPTV y EPG

# Controles de cuándo se ejecuta
on:
  # 1. Automáticamente cada 2 horas
  schedule:
    - cron: '0 */2 * * *'
  
  # 2. Permite la ejecución manual desde la pestaña "Actions"
  workflow_dispatch:

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Obtener el código del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Configurar Python
      - name: Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip' # Cache para acelerar instalaciones futuras

      # 3. Instalar dependencias (requests y lxml)
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      # 4. Instalar 'xml' que es necesario para lxml en algunas acciones
      - name: Instalar librerías XML
        run: sudo apt-get update && sudo apt-get install -y libxml2-dev libxslt-dev

      # 5. Ejecutar el script de Python
      - name: Ejecutar script de procesamiento
        run: python process_iptv.py

      # 6. Guardar los cambios en el repositorio
      - name: Hacer commit y push de los archivos generados
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          
          # Añadir todos los archivos nuevos o modificados
          git add playlist.m3u epg.xml playlist.json info.json epg.xml.gz
          
          # Comprobar si hay cambios antes de hacer commit
          if ! git diff --cached --quiet; then
            git commit -m "Actualización automática de IPTV y EPG"
            git push
          else
            echo "No hay cambios en los archivos generados."
          fi
