# .github/workflows/update.yml

name: Actualizar Playlist (Flujo de 5min / 2h)

on:
  schedule:
    # 1. Se ejecuta cada 5 minutos
    - cron: '*/5 * * * *'
    # 2. Se ejecuta cada 2 horas (a en punto)
    - cron: '0 */2 * * *'
  
  # También permite la ejecución manual
  workflow_dispatch:

# Nombre de la rama de trabajo
env:
  UPDATE_BRANCH: iptv-updates
  MAIN_BRANCH: main # O 'master' si tu rama principal se llama así

jobs:
  build-and-merge:
    runs-on: ubuntu-latest
    
    steps:
      # --- 1. Checkout del código ---
      # Necesitamos un checkout completo para poder movernos entre ramas
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Trae todas las ramas e historial

      # --- 2. Configuración de Python (Se ejecuta siempre) ---
      - name: Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Instalar librerías XML
        run: sudo apt-get update && sudo apt-get install -y libxml2-dev libxslt-dev

      # --- 3. LÓGICA DE 5 MINUTOS (Ejecutar script y guardar en 'iptv-updates') ---
      - name: Ejecutar Script y Guardar en Rama 'updates'
        # Esta sección SOLO se ejecuta en el cron de 5 minutos
        if: github.event.schedule == '*/5 * * * *'
        run: |
          echo "Ejecutando script (job de 5 min)..."
          python process_iptv.py
          
          echo "Guardando cambios en la rama ${{ env.UPDATE_BRANCH }}..."
          git config --global user.name 'GitHub Actions Bot (5min)'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          
          # Crear/cambiar a la rama de updates
          git checkout -B ${{ env.UPDATE_BRANCH }}
          
          # Añadir y comitear cambios
          git add playlist.m3u epg.xml playlist.json info.json epg.xml.gz
          if ! git diff --cached --quiet; then
            git commit -m "Actualización (5 min) de IPTV y EPG"
            # Forzar push. Es necesario por si la rama main se actualizó.
            git push --force origin ${{ env.UPDATE_BRANCH }}
          else
            echo "Script ejecutado, pero no hay cambios en los archivos."
          fi

      # --- 4. LÓGICA DE 2 HORAS (Publicar cambios en 'main') ---
      - name: Fusionar (Merge) 'updates' en 'main'
        # Esta sección SOLO se ejecuta en el cron de 2 horas
        if: github.event.schedule == '0 */2 * * *'
        run: |
          echo "Iniciando job de merge (2 horas)..."
          git config --global user.name 'GitHub Actions Bot (2h-Merger)'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'

          # 1. Traer la rama de updates más reciente
          echo "Trayendo rama ${{ env.UPDATE_BRANCH }}..."
          git fetch origin ${{ env.UPDATE_BRANCH }}

          # 2. Cambiar a la rama main
          echo "Cambiando a rama ${{ env.MAIN_BRANCH }}..."
          git checkout ${{ env.MAIN_BRANCH }}
          git pull origin ${{ env.MAIN_BRANCH }} # Asegurarse de que 'main' está al día

          # 3. FUSIONAR (FORZAR)
          # Hacemos que 'main' sea un reflejo exacto de 'iptv-updates'
          # Esta es la forma más limpia de evitar conflictos de merge
          echo "Sincronizando 'main' con el estado de '${{ env.UPDATE_BRANCH }}'..."
          git reset --hard origin/${{ env.UPDATE_BRANCH }}
          
          # 4. Forzar el push a main para publicar los cambios
          echo "Publicando cambios en ${{ env.MAIN_BRANCH }}..."
          git push --force origin ${{ env.MAIN_BRANCH }}
          
          echo "'main' ha sido actualizado con el contenido de '${{ env.UPDATE_BRANCH }}'."
