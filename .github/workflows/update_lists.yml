name: 锔 Actualizar y Commitear Listas IPTV

on:
  # 1. Ejecuci贸n programada: cada 2 horas
  schedule:
    - cron: '0 */2 * * *'
  
  # 2. Ejecuci贸n manual
  workflow_dispatch:

# Permisos necesarios para que la Action pueda hacer 'git commit'
permissions:
  contents: write # Necesario para hacer commit
  pages: write    # Necesario para desplegar en Pages
  id-token: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    
    steps:
      # --- 1. Configuraci贸n Inicial ---
      
      - name: 猬锔 Descargar el c贸digo del repositorio
        uses: actions/checkout@v4
        # Necesitamos el token para poder hacer push
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name:  Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name:  Instalar dependencias de Python
        run: |
          pip install -r requirements.txt
          
      # --- 2. Ejecuci贸n del Script ---
      
      - name:  Ejecutar el script de Python
        run: |
          python process_streams.py
          
      # --- 3. Generar info.json ---
      
      - name:  Generar info.json con las URLs de GitHub Pages
        run: |
          echo '{' > info.json
          echo '  "m3u_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/filtered.m3u",' >> info.json
          echo '  "json_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.json",' >> info.json
          echo '  "xmltv_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.xml"' >> info.json
          echo '}' >> info.json
          
      # --- 4. Hacer Commit de los cambios ---
      
      - name:  Commitear archivos generados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Chore: Actualizaci贸n autom谩tica de listas IPTV y EPG "
          # Especifica los archivos a commitear
          file_pattern: "filtered.m3u epg.json epg.xml info.json"
          commit_user_name: "GitHub Action Bot"
          commit_user_email: "github-actions-bot@github.com"
          
      # --- 5. Despliegue en GitHub Pages (Opcional si usas los links de 'raw') ---
      # Si prefieres las URLs de github.io, puedes mantener la secci贸n de Pages.
      
      - name: 猬锔 Subir artefactos para GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            filtered.m3u
            epg.json
            epg.xml
            info.json

      - name:  Desplegar en GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
