name: 'Crear y Mergear PR de Listas IPTV 锔'

on:
  # Ejecuci贸n programada: cada 2 horas
  schedule:
    - cron: '0 */2 * * *'
  
  # Ejecuci贸n manual
  workflow_dispatch:

# Permisos necesarios
permissions:
  contents: write      # Para hacer commit y crear ramas
  pull-requests: write # Para crear y mergear PRs

jobs:
  build-and-merge:
    runs-on: ubuntu-latest
    
    steps:
      # --- 1. Configuraci贸n ---
      
      - name: 猬锔 Descargar el c贸digo del repositorio
        uses: actions/checkout@v4

      - name:  Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name:  Instalar dependencias de Python
        run: |
          pip install -r requirements.txt
          
      # --- 2. Ejecuci贸n ---
      
      - name:  Ejecutar el script de Python
        run: |
          python process_streams.py
          
      - name:  Generar info.json
        run: |
          echo '{' > info.json
          echo '  "m3u_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/filtered.m3u",' >> info.json
          echo '  "json_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.json",' >> info.json
          echo '  "xmltv_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/epg.xml"' >> info.json
          echo '}' >> info.json
          
      - name:  Obtener fecha actual
        run: echo "CURRENT_TIME=$(date -u --iso-8601=seconds)" >> $GITHUB_ENV

      # --- 3. Crear el Pull Request ---
      
      - name:  Paso 1: Crear Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Feat: Actualizar listas IPTV y EPG (${{ env.CURRENT_TIME }})"
          branch: "auto-update/iptv-${{ github.run_id }}"
          delete-branch: true # IMPORTANTE: Borra la rama despu茅s de fusionar
          title: "Actualizaci贸n autom谩tica de IPTV/EPG | ${{ env.CURRENT_TIME }}"
          body: |
            Este es un PR autom谩tico generado por GitHub Actions.
          add-paths: |
            filtered.m3u
            epg.json
            epg.xml
            info.json

      # --- 4. Habilitar Auto-Merge ---
      
      - name:  Paso 2: Habilitar Auto-Merge para el PR
        # Solo se ejecuta si el Paso 1 (cpr) realmente cre贸 un PR
        if: steps.cpr.outputs.pull-request-number != ''
        run: |
          # Usamos 'gh pr merge' con la bandera '--auto'
          # Esto le dice a GitHub: "Fusiona esto (con squash) cuando sea posible"
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --auto --squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
